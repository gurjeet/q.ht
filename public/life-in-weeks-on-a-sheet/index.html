<!DOCTYPE html>
<html lang="en" st>
  <head>
    <meta charset="utf-8">
    <title>Life in Weeks, on a Sheet</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
      html
      , body
      , table
      , tbody {
        height: 100%;
        width: 100%;
      }

      tr {
        height: 50%;
      }

      td {
        height: 100%;
        width: 50%;
        text-align: center;
        vertical-align: top;
      }

      p {
        text-align: left;
      }

      #preview-pane {
        height: 100%;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <table><tr>
      <td>
        <h1>Life in Weeks, on One Sheet</h1>
        <h2><a href="https://en.wikipedia.org/wiki/Overview_effect" target="_blank">Overview Effect</a> for your life</h2>
        <label for="name">Name:</label>
        <input id="name" type="text" value="Steve Jobs" oninput="debouncedUpdate()">
        <label for="age">Age:</label>
        <input id="age" type="number" min="0" max="80" value="56" size="4" oninput="debouncedUpdate()">
        <p>
          Enter your name and age, and visualize how much of your life you have spent. Each X marks a week of your life.
        </p>
        <p>
          No data is sent to any server; all processing is done locally in your browser.
        </p>
        <a href="#" onclick="downloadPDF()">Download PDF</a>
      </td>
      </tr>
      <tr>
      <td>
        <!--div id="preview-pane" style="width: 650px; height: 650px;position:relative; z-index:999"-->
        <div id="preview-pane">
        </div>
      </td>
    </tr> </table>

      <script type="text/javascript" src="./lib/jspdf.min.js"></script>
      <script type="text/javascript" src="./lib//pdfobject.min.js"></script>
      <script type="text/javascript">

        const weeksInAYear = 53; // an approximation

        const forceUnifiedViewer = true;
        const leftMargin = 20;
        const nameY = 5;
        const startX = leftMargin;
        const startY = nameY + 5;
        const maxYears = 80;
        const fontSize = 13;
        const footerX = leftMargin;
        const footerY = leftMargin;
        const footerText = "q.ht/life-in-weeks-on-one-sheet";

        var weekMarkerLine = (function() {
          var txt = '';
          var i;
          for( i = 0; i < weeksInAYear; ++i )
            txt += 'X';

          return txt;
        })();

        var getDoc = function() {

          var name = document.getElementById("name").value;
          var age  = document.getElementById("age" ).value;

          var doc = new jsPDF( { putOnlyUsedFonts: true } );

          doc.setFont("courier");
          doc.setFontStyle("bold");
          doc.setFontSize(fontSize);
          doc.text(name, leftMargin, nameY);

          var i;
          var y;
          for( i = 1; i <= maxYears; ++i ) {
            var txt = '';

            if( i < 10)
              txt += " ";

            txt += i + " - " + weekMarkerLine;

            if( i > age)
              doc.setFontStyle("normal");

            y =  (startY + 1) + ((i-1) * 3.5);

            doc.text(txt, startX, y);

            if( i <= age) {
              y -= 1.3;
              doc.line(leftMargin, y, 180, y, "S");
              y -= 0.2;
              doc.line(leftMargin, y, 180, y, "S");
            }
          }

          y += 5;
          doc.setFontStyle("normal");
          doc.setFontSize(6);
          doc.text(footerText, leftMargin, y);

          return doc;
        };

        var update = function() {

          setTimeout(function() {

            var doc = getDoc();

            var options = {
              pdfOpenParams: {
                navpanes: 0,
                toolbar: 0,
                statusbar: 0,
                view: "FitV",
              }
            };

            if (typeof doc !== "undefined") {
              try {
                if ( forceUnifiedViewer
                      || navigator.appVersion.indexOf("MSIE") !== -1
                      || navigator.appVersion.indexOf("Edge") !== -1
                      || navigator.appVersion.indexOf("Trident") !== -1) {

                    options.forcePDFJS = true;
                    options.PDFJS_URL = "./lib/pdfjs-dist-2.4.456-minified/web/viewer.html";

                    PDFObject.embed(doc.output("bloburl"), "#preview-pane", options);

                } else {
                    PDFObject.embed(doc.output("datauristring"), "#preview-pane", options);
                }
              } catch (e) {
                alert("Error " + e);
              }
            }
          }, 0);
        };

        function debounce(func, wait, immediate) {
          var timeout;
          return function() {
            var context = this, args = arguments;
            var later = function() {
              timeout = null;
              if (!immediate) func.apply(context, args);
            };
            var callNow = immediate && !timeout;
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
            if (callNow) func.apply(context, args);
          };
        };

        var downloadPDF = function() {
          var doc = getDoc();
          var name = document.getElementById("name").value;
          doc.save(name + "-life-in-weeks.pdf")
        }

        var debouncedUpdate = debounce(update, 1000, false);

        // Fire the update event once right after loading the page
        debouncedUpdate();
      </script>
  </body>
</html>
